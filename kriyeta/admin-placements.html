<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Placements | Admin Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .placement-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #eee;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: start;
            transition: 0.2s;
        }

        .placement-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .pc-content h3 {
            margin: 0 0 0.5rem 0;
            color: #333;
        }

        .pc-content p {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            color: #666;
        }

        .pc-tag {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            background: #eef2ff;
            color: var(--primary-color);
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .pc-actions {
            display: flex;
            gap: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            width: 600px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 12px;
            padding: 2rem;
        }
    </style>
</head>

<body class="admin-body">
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <span class="material-icons-round">terminal</span>
                <span>Path<span class="highlight-white">lynx</span></span>
            </div>
            <nav class="sidebar-menu">
                <a href="admin-dashboard.html" class="menu-item"><span
                        class="material-icons-round">dashboard</span>Dashboard</a>
                <a href="admin-placements.html" class="menu-item active"><span
                        class="material-icons-round">business_center</span>Placements</a>
                <a href="admin-internships.html" class="menu-item"><span
                        class="material-icons-round">work_outline</span>Internships</a>
                <a href="admin-hackathons.html" class="menu-item"><span
                        class="material-icons-round">code</span>Hackathons</a>
                <a href="admin-students.html" class="menu-item"><span
                        class="material-icons-round">people</span>Students</a>
            </nav>
            <div class="sidebar-footer">
                <a href="admin-login.html" class="menu-item logout" onclick="localStorage.removeItem('Admin')"><span
                        class="material-icons-round">logout</span>Logout</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header-modern">
                <h2>Placement Opportunities</h2>
                <button class="btn-add-new" onclick="openModal()">
                    <span class="material-icons-round">add_circle</span> Add New Opportunity
                </button>
            </header>

            <!-- Stats -->
            <div class="admin-stats-modern">
                <div class="stat-card-v2">
                    <div class="stat-icon-wrapper icon-blue">
                        <span class="material-icons-round">campaign</span>
                    </div>
                    <div class="stat-info">
                        <h3 id="stats-total">0</h3>
                        <p>Total Posted</p>
                    </div>
                </div>
                <div class="stat-card-v2">
                    <div class="stat-icon-wrapper icon-green">
                        <span class="material-icons-round">work_history</span>
                    </div>
                    <div class="stat-info">
                        <h3 id="stats-active">0</h3>
                        <p>Active Now</p>
                    </div>
                </div>
            </div>

            <!-- List -->
            <div id="placements-list" class="admin-grid-container" style="margin-top: 2rem;">
                <!-- Injected via JS -->
            </div>
        </main>
    </div>

    <!-- Create Modal -->
    <div id="create-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h3>Add New Placement</h3>
                <span class="material-icons-round" onclick="closeModal()"
                    style="cursor:pointer; color:#999;">close</span>
            </div>

            <form id="create-form">
                <div class="form-grid">
                    <div class="input-group">
                        <label>Company Name</label>
                        <input type="text" id="p-company" required placeholder="Google">
                    </div>
                    <div class="input-group">
                        <label>Job Role</label>
                        <input type="text" id="p-role" required placeholder="SDE Intern">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="input-group">
                        <label>Domain</label>
                        <select id="p-domain">
                            <option>Software</option>
                            <option>Data Science</option>
                            <option>Core Engineering</option>
                            <option>Management</option>
                            <option>Marketing</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Location</label>
                        <input type="text" id="p-location" required placeholder="Bangalore / Remote">
                    </div>
                </div>

                <div class="input-group" style="margin-bottom:1rem;">
                    <label>Apply Link</label>
                    <input type="url" id="p-link" required placeholder="https://careers.google.com/...">
                </div>

                <div class="form-grid">
                    <div class="input-group">
                        <label>Eligibility (Batch/Branch)</label>
                        <input type="text" id="p-eligibility" placeholder="All Branches, 2026 Batch">
                    </div>
                    <div class="input-group">
                        <label>Deadline</label>
                        <input type="date" id="p-deadline" required>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom:1.5rem;">
                    <label>Description (Optional)</label>
                    <textarea id="p-desc" rows="3" placeholder="Key skills required..."></textarea>
                </div>

                <button type="submit" class="btn-primary btn-block">Publish Opportunity</button>
            </form>
        </div>
    </div>

    <script>
        // Auth Check
        if (!localStorage.getItem("Admin")) {
            window.location.href = "admin-login.html";
        }

        const modal = document.getElementById("create-modal");

        function openModal() { modal.style.display = "flex"; }
        function closeModal() { modal.style.display = "none"; }

        // Fetch & Render
        async function fetchPlacements() {
            try {
                const res = await fetch("http://localhost:5000/api/admin/placements");
                const data = await res.json();
                renderList(data);
                updateStats(data);
            } catch (err) {
                console.error(err);
                alert("Failed to load placements");
            }
        }

        function renderList(list) {
            const container = document.getElementById("placements-list");
            if (list.length === 0) {
                container.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:3rem; color:#888;">No placements posted yet. Click "Add New" to start.</div>';
                return;
            }

            container.innerHTML = list.map(item => {
                // Status Logic
                let statusClass = 'status-active';
                if (item.status === 'Closed' || item.status === 'Application Closed') statusClass = 'status-closed';

                // Deadline Logic
                const deadlineDate = new Date(item.deadline);
                const today = new Date();
                const diffTime = deadlineDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                let deadlineStyle = '';
                let deadlineText = deadlineDate.toLocaleDateString();

                if (diffDays < 0) {
                    deadlineText = 'Expired';
                    deadlineStyle = 'color:#c5221f; font-weight:700;';
                } else if (diffDays <= 5) {
                    deadlineText += ' (Urgent)';
                    deadlineStyle = 'color:#d93025; font-weight:700;';
                }

                // Initial for logo
                const initial = item.companyName ? item.companyName.charAt(0).toUpperCase() : '?';

                return `
                <div class="admin-card">
                    <div class="ac-header">
                        <div class="ac-company">
                            <div class="ac-logo">${initial}</div>
                            <span class="ac-name">${item.companyName}</span>
                        </div>
                        <span class="ac-status ${statusClass}">${item.status}</span>
                    </div>
                    
                    <div class="ac-role">${item.role}</div>
                    
                    <div class="ac-tags">
                        <span class="ac-tag">${item.domain}</span>
                        <span class="ac-tag" title="Eligibility">${item.eligibility}</span>
                    </div>

                    <div class="ac-details">
                        <div class="ac-detail-item">
                            <div class="ac-label">Location</div>
                            <div class="ac-value">${item.location}</div>
                        </div>
                        <div class="ac-detail-item">
                            <div class="ac-label">Deadline</div>
                            <div class="ac-value" style="${deadlineStyle}">${deadlineText}</div>
                        </div>
                    </div>

                    <div class="ac-actions">
                        <button class="btn-icon-soft btn-view" onclick="window.open('${item.applyLink}', '_blank')">
                            <span class="material-icons-round" style="font-size:16px">open_in_new</span> View
                        </button>
                        <button class="btn-icon-soft btn-delete" onclick="deletePlacement('${item._id}')">
                            <span class="material-icons-round" style="font-size:16px">delete</span> Delete
                        </button>
                    </div>
                </div>
            `}).join("");
        }

        function updateStats(list) {
            document.getElementById("stats-total").textContent = list.length;
            const active = list.filter(i => i.status === "Active" && new Date(i.deadline) >= new Date()).length;
            document.getElementById("stats-active").textContent = active;
        }

        // Create Placement
        document.getElementById("create-form").addEventListener("submit", async (e) => {
            e.preventDefault();

            const payload = {
                companyName: document.getElementById("p-company").value,
                role: document.getElementById("p-role").value,
                domain: document.getElementById("p-domain").value,
                location: document.getElementById("p-location").value,
                applyLink: document.getElementById("p-link").value,
                deadline: document.getElementById("p-deadline").value,
                eligibility: document.getElementById("p-eligibility").value,
                description: document.getElementById("p-desc").value
            };

            try {
                const res = await fetch("http://localhost:5000/api/admin/placements/create", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert("Posted successfully!");
                    closeModal();
                    document.getElementById("create-form").reset();
                    fetchPlacements();
                } else {
                    alert("Failed to post");
                }
            } catch (err) {
                alert("Server error");
            }
        });

        // Delete Placement
        async function deletePlacement(id) {
            if (!confirm("Are you sure you want to delete this placement?")) return;

            try {
                const res = await fetch(`http://localhost:5000/api/admin/placements/${id}`, { method: "DELETE" });
                if (res.ok) fetchPlacements();
            } catch (err) {
                alert("Delete failed");
            }
        }

        // Init
        fetchPlacements();
    </script>
</body>

</html>